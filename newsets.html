<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SetHub New Sets</title>
  <meta name="description" content="SetHub New Sets" />
  <meta name="theme-color" content="#0E141A" />
  <link rel="icon" type="image/png" href="Bilder/lagos.png" />

  <style>
    :root{
      --bg:#0E141A;
      --fg:#E6E9ED;
      --muted:#9AA4AE;

      --glass:rgba(16,24,32,.72);
      --glass2:rgba(16,24,32,.55);

      --border:#223041;
      --border2:#1f2a35;

      --shadow:0 26px 90px rgba(0,0,0,.55);

      --r1:18px;
      --r2:23px;

      --gap:16px;

      --pink:#cf64e5;
      --cyan:#00e5ff;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--fg);
      background:var(--bg);
      overflow-x:hidden;
      min-height:100vh;
    }
    img{max-width:100%;display:block;height:auto}
    a{color:inherit;text-decoration:none}
    button{font:inherit}

    header.site{
      position:fixed;
      left:0;
      right:0;
      top:0;
      height:78px;
      background:rgba(16,24,32,.65);
      backdrop-filter:blur(10px);
      border-bottom:1px solid #0f1a22;
      z-index:50;
    }

    .topbar-inner{
      height:100%;
      width:min(1240px,100%);
      margin:0 auto;
      padding:0 14px;
      display:grid;
      grid-template-columns:56px 1fr 56px;
      align-items:center;
    }

    .nav-brand{
      grid-column:2;
      justify-self:center;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.6rem;
      min-width:0;
      transform:translateY(4px);
    }

    .logo-svg{width:100%;height:100%;display:block}

    .nav-logo{
      height:48px;
      width:auto;
      display:grid;
      place-items:center;
      transform:translateY(10px);
      flex:0 0 auto;
    }

    .nav-text{
      display:flex;
      align-items:center;
      gap:.15em;
      line-height:1;
      font-weight:900;
      letter-spacing:.04em;
      color:#fff;
      font-size:1.6rem;
      white-space:nowrap;
    }

    .burger{
      position:fixed;
      top:16px;
      left:14px;
      z-index:60;
      width:46px;
      height:46px;
      border-radius:12px;
      background:var(--glass);
      border:1px solid var(--border2);
      backdrop-filter:blur(10px);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition:transform .12s ease, filter .12s ease;
    }
    .burger:hover{transform:translateY(-1px);filter:brightness(1.06)}

    .burger .lines{width:20px;height:14px;position:relative}
    .burger .lines span{
      position:absolute;
      left:0;
      right:0;
      height:2px;
      background:#e8eef4;
      border-radius:2px;
      transition:transform .25s ease, opacity .2s ease, top .25s ease;
    }
    .burger .lines span:nth-child(1){top:0}
    .burger .lines span:nth-child(2){top:6px}
    .burger .lines span:nth-child(3){top:12px}

    body.drawer-open .burger .lines span:nth-child(1){top:6px;transform:rotate(45deg)}
    body.drawer-open .burger .lines span:nth-child(2){opacity:0}
    body.drawer-open .burger .lines span:nth-child(3){top:6px;transform:rotate(-45deg)}

    .top-links{
      position:fixed;
      top:16px;
      left:68px;
      z-index:59;
      display:flex;
      gap:10px;
    }

    .top-link{
      height:46px;
      padding:0 14px;
      border-radius:12px;
      background:var(--glass);
      border:1px solid var(--border2);
      backdrop-filter:blur(10px);
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      color:#fff;
      letter-spacing:.02em;
      white-space:nowrap;
      transition:transform .12s ease, filter .12s ease;
    }
    .top-link:hover{transform:translateY(-1px);filter:brightness(1.06)}
    .top-link span{color:#b7c2cc;font-weight:800}

    @media (max-width:720px){
      header.site{height:72px}
      .nav-logo{height:44px}
      .nav-text{font-size:1.45rem}
      .burger{width:44px;height:44px;top:14px;left:12px}
      .top-links{top:14px;left:62px;gap:8px}
      .top-link{height:44px;padding:0 12px}
      .top-link span{display:none}
    }
    @media (max-width:520px){
      .top-links{display:none}
    }

    .drawer{
      position:fixed;
      top:0;
      left:0;
      bottom:0;
      width:min(320px,86vw);
      background:rgba(12,18,24,.98);
      border-right:1px solid #16212a;
      z-index:58;
      transform:translateX(-100%);
      transition:transform .32s ease;
      display:flex;
      flex-direction:column;
      padding:90px 18px 18px;
      gap:10px;
    }
    body.drawer-open .drawer{transform:translateX(0)}

    .drawer a{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 14px;
      border-radius:12px;
      background:#0f1820;
      border:1px solid #1a2530;
      font-weight:900;
      letter-spacing:.02em;
      color:#fff;
    }
    .drawer a:hover{background:#13202a}
    .drawer small{color:#94a3b8;font-weight:800}

    .drawer-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      z-index:57;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease;
    }
    body.drawer-open .drawer-backdrop{opacity:1;pointer-events:auto}

    main{
      padding:92px 5% 64px;
      width:min(1240px,100%);
      margin:0 auto;
    }
    @media (max-width:720px){ main{padding-top:84px} }
    @media (max-width:420px){ main{padding-inline:4%} }

    .panel{
      border-radius:var(--r2);
      background:
        radial-gradient(1200px 700px at 72% 22%, rgba(236,72,153,.18), transparent 70%),
        radial-gradient(1100px 650px at 78% 82%, rgba(59,130,246,.16), transparent 65%),
        rgba(15,22,30,.70);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:clamp(14px,2.2vw,20px);
    }

    .head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      margin-bottom:14px;
    }

    .title{
      font-weight:950;
      font-size:clamp(2rem,3.4vw,2.7rem);
      letter-spacing:.01em;
    }

    .sub{
      margin-top:6px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-size:.85rem;
    }

    .tools{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .search{
      height:44px;
      width:min(420px,56vw);
      display:flex;
      align-items:center;
      gap:10px;
      padding:0 12px;
      border-radius:14px;
      background:var(--glass2);
      border:1px solid var(--border2);
      backdrop-filter:blur(10px);
    }
    .search svg{width:18px;height:18px;color:#cfd6dd;flex:0 0 auto}
    .search input{
      width:100%;
      background:transparent;
      border:0;
      outline:0;
      color:#fff;
      font-weight:900;
      letter-spacing:.01em;
    }
    .search input::placeholder{color:#9aa4ae}

    .pill{
      height:44px;
      padding:0 12px;
      border-radius:14px;
      background:var(--glass2);
      border:1px solid var(--border2);
      color:#fff;
      font-weight:900;
      letter-spacing:.02em;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:10px;
      transition:transform .12s ease, filter .12s ease;
    }
    .pill:hover{transform:translateY(-1px);filter:brightness(1.06)}
    .pill small{color:#b7c2cc;font-weight:800}

    @media (max-width:720px){
      .head{flex-direction:column;align-items:stretch}
      .tools{justify-content:flex-start}
      .search{width:100%}
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:var(--gap);
      margin-top:12px;
    }
    @media (max-width:1100px){
      .grid{grid-template-columns:repeat(3,minmax(0,1fr))}
    }
    @media (max-width:860px){
      .grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media (max-width:520px){
      .grid{grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    }

    .card{
      border-radius:22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(900px 520px at 15% -10%, rgba(0,229,255,.10), transparent 62%),
        radial-gradient(900px 520px at 92% 120%, rgba(207,100,229,.12), transparent 62%),
        linear-gradient(180deg,#101820,#0b1218);
      transform:translateY(0);
      transition:transform .15s ease, border-color .15s ease, filter .15s ease;
      display:flex;
      flex-direction:column;
      min-height:100%;
      box-shadow:0 18px 70px rgba(0,0,0,.45);
    }
    .card:hover{
      transform:translateY(-2px);
      border-color:rgba(255,255,255,.16);
      filter:brightness(1.02);
    }

    .thumb{
      position:relative;
      width:100%;
      height:210px;
      background:
        radial-gradient(520px 280px at 60% 15%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
      border-bottom:1px solid rgba(255,255,255,.06);
      display:grid;
      place-items:center;
      padding:12px;
    }

    @media (max-width:860px){
      .thumb{height:220px}
    }
    @media (max-width:520px){
      .thumb{height:200px}
    }

    .thumb img{
      width:100%;
      height:100%;
      object-fit:contain;
      object-position:center;
      filter:drop-shadow(0 16px 40px rgba(0,0,0,.45));
      transform:translateY(2px);
    }

    .fade{
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      height:76px;
      background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.55));
      pointer-events:none;
    }

    .badge{
      position:absolute;
      left:10px;
      top:10px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(12,18,24,.72);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;
      font-weight:950;
      letter-spacing:.02em;
      font-size:.78rem;
      backdrop-filter:blur(10px);
      max-width:calc(100% - 20px);
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }

    .wish{
      position:absolute;
      right:10px;
      top:10px;
      height:38px;
      width:38px;
      border-radius:14px;
      background:rgba(12,18,24,.65);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter:blur(10px);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition:transform .12s ease, filter .12s ease;
    }
    .wish:hover{transform:translateY(-1px);filter:brightness(1.06)}
    .wish svg{width:18px;height:18px;color:#fff}

    .wish.is-on{
      border-color:rgba(207,100,229,.65);
      background:linear-gradient(180deg,#7a3bd0,#572B87);
    }

    .card-body{
      padding:12px 12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1;
    }

    .t1{
      font-weight:950;
      font-size:1.02rem;
      line-height:1.2;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height:2.4em;
    }

    .t2{
      color:#d7dde3;
      font-weight:800;
      font-size:.92rem;
      opacity:.92;
      line-height:1.2;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height:2.2em;
    }

    .meta-row{
      margin-top:auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color:#cfd6dd;
      font-weight:950;
      font-size:.88rem;
      opacity:.92;
    }

    .open{
      height:34px;
      width:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(16,24,32,.45);
      display:grid;
      place-items:center;
      flex:0 0 auto;
    }
    .open svg{width:18px;height:18px;color:#fff}

    .skeleton{
      border-radius:22px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(16,24,32,.35);
      height:320px;
    }

    .empty{
      margin-top:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(16,24,32,.35);
      padding:14px;
      color:#cfd6dd;
      font-weight:800;
      line-height:1.4;
      display:none;
    }

    .pager{
      margin-top:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .pager-left{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pager-right{
      color:#cfd6dd;
      font-weight:950;
      letter-spacing:.02em;
      opacity:.92;
    }

    .page-list{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pbtn{
      height:38px;
      min-width:38px;
      padding:0 12px;
      border-radius:14px;
      background:rgba(16,24,32,.55);
      border:1px solid #1f2a35;
      color:#fff;
      font-weight:950;
      cursor:pointer;
      transition:transform .12s ease, filter .12s ease, opacity .12s ease;
    }
    .pbtn:hover{transform:translateY(-1px);filter:brightness(1.06)}
    .pbtn[disabled]{opacity:.5;cursor:default;transform:none;filter:none}
    .pbtn.active{
      background:linear-gradient(180deg,#7a3bd0,#572B87);
      border-color:rgba(207,100,229,.65);
    }
  </style>
</head>

<body>
  <button class="burger" id="burgerBtn" aria-label="Menü öffnen" type="button">
    <div class="lines" aria-hidden="true">
      <span></span><span></span><span></span>
    </div>
  </button>

  <div class="top-links" id="topLinks" aria-label="Quick Links">
    <a class="top-link" href="/news.html" aria-label="News">
      <strong>News</strong><span>Updates</span>
    </a>
    <a class="top-link" href="/events.html" aria-label="Events">
      <strong>Events</strong><span>Dates</span>
    </a>
    <a class="top-link" href="/sets.html" aria-label="New Sets">
      <strong>New Sets</strong><span>List</span>
    </a>
  </div>

  <nav class="drawer" id="drawer" aria-label="Menü">
    <a href="/index.html" class="drawer-link">Home<small>Start</small></a>
    <a href="/news.html" class="drawer-link">News<small>Updates</small></a>
    <a href="/events.html" class="drawer-link">Events<small>Dates</small></a>
    <a href="/sets.html" class="drawer-link">New Sets<small>List</small></a>
    <a href="/index.html#impressum" class="drawer-link">Impressum<small>Legal</small></a>
  </nav>
  <div class="drawer-backdrop" id="drawerBackdrop" aria-hidden="true"></div>

  <svg width="0" height="0" style="position:absolute;left:-9999px;top:-9999px" aria-hidden="true" focusable="false">
    <symbol id="sethub-logo" viewBox="0 0 3326 2408" preserveAspectRatio="xMidYMid meet">
      <defs>
        <g id="logo-geometry">
          <g id="Ebene_3">
            <path fill="#04d5eb" fill-rule="evenodd" d="M1421.54,318.24c22.25,62.73,139.85,77.99,200.88,77.76,17.07-.06,161.51-2.01,187.92-71.28,7.3-19.15,6.91-46.93,6.48-77.76-.45-31.95-.57-47.96-5.79-61.91-24.9-66.46-125.71-83.15-149.73-87.13-16.28-2.7-49.47-6.7-90.72,0-27.93,4.54-123.89,20.12-149.04,84.24-6.27,16-6.23,32.31-6.48,64.8-.17,22.34-.39,51.9,6.48,71.28ZM1434.5,208.08c0-48.05,91.62-90.72,184.74-90.72s178.14,42.67,178.14,90.72-91.62,97.2-184.74,97.2-178.14-49.15-178.14-97.2Z"></path>
            <path fill="#04d5eb" fill-rule="evenodd" d="M1826.54,534.24c22.25,62.73,139.85,77.99,200.88,77.76,17.07-.06,161.51-2.01,187.92-71.28,7.3-19.15,6.91-46.93,6.48-77.76-.45-31.95-.57-47.96-5.79-61.91-24.9-66.46-125.71-83.15-149.73-87.13-16.28-2.7-49.47-6.7-90.72,0-27.93,4.54-123.89,20.12-149.04,84.24-6.27,16-6.23,32.31-6.48,64.8-.17,22.34-.39,51.9,6.48,71.28ZM1839.5,424.08c0-48.05,91.62-90.72,184.74-90.72s178.14,42.67,178.14,90.72-91.62,97.2-184.74,97.2-178.14-49.15-178.14-97.2Z"></path>
            <path fill="#04d5eb" fill-rule="evenodd" d="M1421.54,799.99c22.25,62.73,139.85,77.99,200.88,77.76,17.07-.06,161.51-2.01,187.92-71.28,7.3-19.15,6.91-46.93,6.48-77.76-.45-31.95-.57-47.96-5.79-61.91-24.9-66.46-125.71-83.15-149.73-87.13-16.28-2.7-49.47-6.7-90.72,0-27.93,4.54-123.89,20.12-149.04,84.24-6.27,16-6.23,32.31-6.48,64.8-.17,22.34-.39,51.9,6.48,71.28ZM1434.5,689.83c0-48.05,91.62-90.72,184.74-90.72s178.14,42.67,178.14,90.72-91.62,97.2-184.74,97.2-178.14-49.15-178.14-97.2Z"></path>
            <path fill="#04d5eb" fill-rule="evenodd" d="M1019.52,534.24c22.25,62.73,139.85,77.99,200.88,77.76,17.07-.06,161.51-2.01,187.92-71.28,7.3-19.15,6.91-46.93,6.48-77.76-.45-31.95-.57-47.96-5.79-61.91-24.9-66.46-125.71-83.15-149.73-87.13-16.28-2.7-49.47-6.7-90.72,0-27.93,4.54-123.89,20.12-149.04,84.24-6.27,16-6.23,32.31-6.48,64.8-.17,22.34-.39,51.9,6.48,71.28ZM1032.48,424.08c0-48.05,91.62-90.72,184.74-90.72s178.14,42.67,178.14,90.72-91.62,97.2-184.74,97.2-178.14-49.15-178.14-97.2Z"></path>
          </g>
          <g id="Ebene_5">
            <path fill="#04d5eb" d="M1586,1605l-765-450v-585l765,459v576Z"></path>
            <path fill="#04d5eb" d="M1640,1605l765-450v-585l-765,459v576Z"></path>
          </g>
        </g>
      </defs>
      <use href="#logo-geometry"></use>
    </symbol>
  </svg>

  <header class="site" aria-label="Navigation">
    <div class="topbar-inner">
      <div class="nav-brand">
        <div class="nav-logo" aria-hidden="true">
          <svg class="logo-svg" viewBox="0 0 3326 2408" preserveAspectRatio="xMidYMid meet">
            <use href="#sethub-logo"></use>
          </svg>
        </div>
        <div class="nav-text" aria-label="SetHub">
          <span>S</span><span>e</span><span>t</span><span>H</span><span>u</span><span>b</span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="panel">
      <div class="head">
        <div>
          <div class="title">New Sets</div>
          <div class="sub" id="subLine">Lädt</div>
        </div>

        <div class="tools">
          <div class="search" role="search" aria-label="Suche">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M10.5 19a8.5 8.5 0 1 1 0-17 8.5 8.5 0 0 1 0 17Z" stroke="currentColor" stroke-width="2"></path>
              <path d="M16.8 16.8 22 22" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
            </svg>
            <input id="q" type="search" placeholder="Search name, theme, number" autocomplete="off" />
          </div>

          <button class="pill" id="sortBtn" type="button" aria-label="Sortieren">
            Sort
            <small id="sortLabel">New</small>
          </button>

          <button class="pill" id="reloadBtn" type="button" aria-label="Neu laden">
            Reload
            <small id="countLabel">0</small>
          </button>
        </div>
      </div>

      <div class="grid" id="grid" aria-label="New Sets Grid">
        <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
        <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
      </div>

      <div class="empty" id="empty">Nichts gefunden</div>

      <div class="pager" id="pager" style="display:none">
        <div class="pager-left">
          <button class="pbtn" id="prevPage" type="button">Prev</button>
          <div class="page-list" id="pageList" aria-label="Seiten"></div>
          <button class="pbtn" id="nextPage" type="button">Next</button>
        </div>
        <div class="pager-right" id="pageInfo">Page</div>
      </div>
    </div>
  </main>

  <script>
    const SETS_API_URL = "https://sethub.ddnsfree.com/NewSetsScraper/api/LegoProducts/"
    const FALLBACK_IMG = "/Bilder/real1.png"
    const PER_PAGE = 28

    const WISHLIST_KEY = "sethub_wishlist_v1"

    const burgerBtn = document.getElementById("burgerBtn")
    const drawerBackdrop = document.getElementById("drawerBackdrop")

    function openDrawer(){ document.body.classList.add("drawer-open") }
    function closeDrawer(){ document.body.classList.remove("drawer-open") }

    burgerBtn.addEventListener("click", () => {
      document.body.classList.contains("drawer-open") ? closeDrawer() : openDrawer()
    })
    drawerBackdrop.addEventListener("click", closeDrawer)
    document.querySelectorAll(".drawer-link").forEach(a => a.addEventListener("click", closeDrawer))
    addEventListener("keydown", e => { if(e.key === "Escape") closeDrawer() })

    function safeText(s){
      return String(s || "").replaceAll("<","").replaceAll(">","")
    }

    function firstText(o, keys){
      for(const k of keys){
        const v = o && o[k]
        if(v !== undefined && v !== null && String(v).trim() !== "") return String(v)
      }
      return ""
    }

    function formatDate(iso){
      const d = new Date(iso)
      if(Number.isNaN(d.getTime())) return ""
      const day = String(d.getDate()).padStart(2,"0")
      const mon = String(d.getMonth() + 1).padStart(2,"0")
      const yr = String(d.getFullYear())
      return `${day}.${mon}.${yr}`
    }

    function dedupeSets(items){
      const seen = new Set()
      const out = []
      for(const it of items){
        const name = firstText(it, ["name","title","setName"]).trim()
        const num = firstText(it, ["setNumber","number","id"]).trim()
        const key = `${name}__${num}`
        if(seen.has(key)) continue
        seen.add(key)
        out.push(it)
      }
      return out
    }

    function guessStamp(it){
      const d = firstText(it, ["publishedAt","date","createdAt","releaseDate"])
      const t = new Date(d || 0).getTime()
      return Number.isFinite(t) ? t : 0
    }

    function guessPrice(it){
      const p = firstText(it, ["price","msrp","eur","usd"])
      const n = Number(String(p).replace(",",".").replace(/[^0-9.]/g,""))
      return Number.isFinite(n) ? n : 0
    }

    const SORTS = [
      { key:"new", label:"New", fn:(a,b)=> guessStamp(b) - guessStamp(a) },
      { key:"name", label:"Name", fn:(a,b)=> (firstText(a,["name","title","setName"]).localeCompare(firstText(b,["name","title","setName"]))) },
      { key:"price", label:"Price", fn:(a,b)=> guessPrice(b) - guessPrice(a) }
    ]

    function loadWishlist(){
      try{
        const v = JSON.parse(localStorage.getItem(WISHLIST_KEY) || "[]")
        return Array.isArray(v) ? new Set(v.map(String)) : new Set()
      }catch{
        return new Set()
      }
    }

    function saveWishlist(set){
      localStorage.setItem(WISHLIST_KEY, JSON.stringify(Array.from(set)))
    }

    let wishlist = loadWishlist()

    function itemKey(it){
      const num = firstText(it, ["setNumber","number","id"]).trim()
      const name = firstText(it, ["name","title","setName"]).trim()
      return num ? `n:${num}` : `t:${name}`
    }

    let raw = []
    let filtered = []
    let sortIdx = 0

    let page = 1
    let pages = 1

    const grid = document.getElementById("grid")
    const empty = document.getElementById("empty")
    const q = document.getElementById("q")
    const sortBtn = document.getElementById("sortBtn")
    const sortLabel = document.getElementById("sortLabel")
    const reloadBtn = document.getElementById("reloadBtn")
    const countLabel = document.getElementById("countLabel")
    const subLine = document.getElementById("subLine")

    const pager = document.getElementById("pager")
    const prevPage = document.getElementById("prevPage")
    const nextPage = document.getElementById("nextPage")
    const pageList = document.getElementById("pageList")
    const pageInfo = document.getElementById("pageInfo")

    function heartSvg(filled){
      if(filled){
        return `
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M12 21s-7.2-4.35-9.6-8.7C.6 8.85 2.4 5.7 5.7 5.1c1.95-.36 3.75.45 4.8 1.77 1.05-1.32 2.85-2.13 4.8-1.77 3.3.6 5.1 3.75 3.3 7.2C19.2 16.65 12 21 12 21Z"></path>
          </svg>
        `
      }
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 21s-7.2-4.35-9.6-8.7C.6 8.85 2.4 5.7 5.7 5.1c1.95-.36 3.75.45 4.8 1.77 1.05-1.32 2.85-2.13 4.8-1.77 3.3.6 5.1 3.75 3.3 7.2C19.2 16.65 12 21 12 21Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"></path>
        </svg>
      `
    }

    function buildCard(it){
      const name = safeText(firstText(it, ["name","title","setName"]) || "Set")
      const num = safeText(firstText(it, ["setNumber","number","id"]))
      const theme = safeText(firstText(it, ["theme","category","line"]))
      const price = safeText(firstText(it, ["price","msrp","eur","usd"]))
      const date = formatDate(firstText(it, ["publishedAt","date","createdAt","releaseDate"]))

      const img = firstText(it, ["imageUrl","image","img","thumbnail","picture"]) || FALLBACK_IMG
      const href = firstText(it, ["productUrl","url","link","sourceUrl"]) || "#"

      const badgeText =
        num ? `${num}${theme ? " · " + theme : ""}` :
        theme ? theme :
        "Set"

      const line2 =
        theme ? theme :
        date ? date :
        ""

      const leftMeta =
        price ? price :
        date ? date :
        " "

      const key = itemKey(it)
      const on = wishlist.has(key)

      return `
        <a class="card" href="${href}" target="_blank" rel="noopener" aria-label="${name}">
          <div class="thumb">
            <img src="${img}" alt="${name}" loading="lazy" onerror="this.onerror=null;this.src='${FALLBACK_IMG}'">
            <div class="fade" aria-hidden="true"></div>
            <div class="badge">${badgeText}</div>

            <button class="wish ${on ? "is-on" : ""}" type="button" data-wish="${key}" aria-label="Wishlist">
              ${heartSvg(on)}
            </button>
          </div>

          <div class="card-body">
            <div class="t1">${name}</div>
            <div class="t2">${line2}</div>
            <div class="meta-row">
              <div>${leftMeta}</div>
              <div class="open" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M7 17L17 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                  <path d="M9 7h8v8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
              </div>
            </div>
          </div>
        </a>
      `
    }

    function setPage(newPage){
      page = Math.max(1, Math.min(newPage, pages))
      render()
      window.scrollTo({ top: 0, behavior: "smooth" })
    }

    function buildPageButtons(){
      pageList.innerHTML = ""

      const maxBtns = 7
      let start = Math.max(1, page - Math.floor(maxBtns / 2))
      let end = start + maxBtns - 1

      if(end > pages){
        end = pages
        start = Math.max(1, end - maxBtns + 1)
      }

      function addBtn(n){
        const btn = document.createElement("button")
        btn.type = "button"
        btn.className = "pbtn" + (n === page ? " active" : "")
        btn.textContent = String(n)
        btn.addEventListener("click", () => setPage(n))
        pageList.appendChild(btn)
      }

      if(start > 1){
        addBtn(1)
        if(start > 2){
          const dots = document.createElement("button")
          dots.type = "button"
          dots.className = "pbtn"
          dots.textContent = "..."
          dots.disabled = true
          pageList.appendChild(dots)
        }
      }

      for(let n = start; n <= end; n++) addBtn(n)

      if(end < pages){
        if(end < pages - 1){
          const dots = document.createElement("button")
          dots.type = "button"
          dots.className = "pbtn"
          dots.textContent = "..."
          dots.disabled = true
          pageList.appendChild(dots)
        }
        addBtn(pages)
      }
    }

    function wireWishlistButtons(){
      const btns = Array.from(grid.querySelectorAll("button[data-wish]"))
      btns.forEach(btn => {
        btn.addEventListener("click", e => {
          e.preventDefault()
          e.stopPropagation()

          const key = String(btn.getAttribute("data-wish") || "")
          if(!key) return

          if(wishlist.has(key)) wishlist.delete(key)
          else wishlist.add(key)

          saveWishlist(wishlist)

          const on = wishlist.has(key)
          btn.classList.toggle("is-on", on)
          btn.innerHTML = heartSvg(on)
        })
      })
    }

    function render(){
      const total = filtered.length
      pages = Math.max(1, Math.ceil(total / PER_PAGE))
      page = Math.min(page, pages)

      const start = (page - 1) * PER_PAGE
      const slice = filtered.slice(start, start + PER_PAGE)

      grid.innerHTML = slice.map(buildCard).join("")
      empty.style.display = slice.length ? "none" : "block"

      countLabel.textContent = String(total)
      sortLabel.textContent = SORTS[sortIdx].label

      subLine.textContent = total ? `${total} items` : "0 items"

      prevPage.disabled = page <= 1
      nextPage.disabled = page >= pages

      pageInfo.textContent = `Page ${page} of ${pages}`
      pager.style.display = pages > 1 ? "flex" : "none"

      if(pages > 1) buildPageButtons()
      wireWishlistButtons()
    }

    function apply(){
      const term = q.value.trim().toLowerCase()

      const base = term
        ? raw.filter(it => {
            const name = firstText(it, ["name","title","setName"]).toLowerCase()
            const num = firstText(it, ["setNumber","number","id"]).toLowerCase()
            const theme = firstText(it, ["theme","category","line"]).toLowerCase()
            const price = firstText(it, ["price","msrp","eur","usd"]).toLowerCase()
            return name.includes(term) || num.includes(term) || theme.includes(term) || price.includes(term)
          })
        : raw.slice()

      const sorter = SORTS[sortIdx]
      filtered = base.sort(sorter.fn)

      page = 1
      render()
    }

    function withTimeout(ms){
      const controller = new AbortController()
      const t = setTimeout(() => controller.abort(), ms)
      return { signal: controller.signal, clear: () => clearTimeout(t) }
    }

    async function fetchJson(url){
      const { signal, clear } = withTimeout(14000)
      let res
      try{
        res = await fetch(url, {
          method:"GET",
          mode:"cors",
          cache:"no-store",
          headers:{ "Accept":"application/json" },
          signal
        })
      } finally {
        clear()
      }
      if(!res.ok) throw new Error("bad status")
      return await res.json()
    }

    async function load(){
      subLine.textContent = "Lädt"
      grid.innerHTML = `
        <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
        <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
      `
      empty.style.display = "none"
      pager.style.display = "none"

      const data = await fetchJson(SETS_API_URL)
      const list = Array.isArray(data) ? data : []
      raw = dedupeSets(list)

      apply()
    }

    q.addEventListener("input", () => apply())

    sortBtn.addEventListener("click", () => {
      sortIdx = (sortIdx + 1) % SORTS.length
      apply()
    })

    reloadBtn.addEventListener("click", () => load())

    prevPage.addEventListener("click", () => setPage(page - 1))
    nextPage.addEventListener("click", () => setPage(page + 1))

    load().catch(() => {
      raw = []
      filtered = []
      grid.innerHTML = ""
      empty.style.display = "block"
      subLine.textContent = "Keine Verbindung"
      countLabel.textContent = "0"
      pager.style.display = "none"
    })
  </script>
</body>
</html>
