<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SetHub Sale</title>
  <meta name="description" content="SetHub Sale – Deals von Amazon, LEGO, Alternate" />
  <meta name="theme-color" content="#0E141A" />

  <style>
    :root{
      --bg:#0E141A;
      --panel:rgba(16,24,32,.55);
      --panel2:rgba(16,24,32,.72);
      --fg:#E6E9ED;
      --muted:#9AA4AE;
      --border:#213140;
      --border2:#0f1a22;
      --pink:#cf64e5;
      --cyan:#00E5FF;
      --shadow:0 30px 120px rgba(0,0,0,.55);
      --r:18px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);
      color:var(--fg);
      min-height:100vh;
      overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}
    button,input,select{font:inherit}

    header{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:blur(12px);
      background:rgba(16,24,32,.65);
      border-bottom:1px solid var(--border2);
    }

    .topbar{
      width:min(1400px,100%);
      margin:0 auto;
      padding:14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brand .dot{
      width:38px;
      height:38px;
      border-radius:12px;
      background:linear-gradient(180deg,#7a3bd0,#572B87);
      border:1px solid rgba(207,100,229,.65);
      box-shadow:0 16px 50px rgba(0,0,0,.45);
    }
    .brand strong{
      font-weight:950;
      letter-spacing:.05em;
      white-space:nowrap;
    }
    .brand span{
      color:var(--muted);
      font-weight:800;
      margin-left:8px;
      white-space:nowrap;
    }

    .navlinks{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .navbtn{
      height:42px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel2);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .navbtn:hover{filter:brightness(1.06);transform:translateY(-1px)}
    .navbtn:active{transform:translateY(0)}
    .navbtn small{color:#b7c2cc;font-weight:800}

    main{
      width:min(1400px,100%);
      margin:0 auto;
      padding:18px 14px 60px;
    }

    .hero{
      position:relative;
      border-radius:26px;
      border:1px solid #223041;
      background:
        radial-gradient(1100px 650px at 72% 18%, rgba(236,72,153,.28), transparent 70%),
        radial-gradient(900px 600px at 84% 88%, rgba(59,130,246,.24), transparent 65%),
        rgba(15,22,30,.55);
      backdrop-filter:blur(14px);
      box-shadow:var(--shadow);
      padding:18px;
      overflow:hidden;
    }

    .herohead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }

    .title{
      font-size:2.1rem;
      font-weight:950;
      letter-spacing:.02em;
      line-height:1.05;
    }
    .subtitle{
      margin-top:6px;
      color:#cfd6dd;
      font-weight:800;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:.85rem;
    }

    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .pill{
      border:1px solid var(--border);
      background:rgba(12,18,24,.55);
      border-radius:999px;
      padding:10px 12px;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .pill span{color:var(--muted);font-weight:800}

    .controls{
      margin-top:14px;
      display:grid;
      grid-template-columns:1.2fr .7fr .7fr .5fr;
      gap:10px;
      align-items:center;
    }

    .field{
      height:46px;
      border-radius:14px;
      border:1px solid #223041;
      background:rgba(16,24,32,.55);
      color:#e8eef4;
      outline:none;
      padding:0 12px;
      font-weight:850;
      width:100%;
    }
    .field:focus{box-shadow:0 0 0 4px rgba(207,100,229,.10)}
    .field::placeholder{color:#9aa4ae}

    .btn{
      height:46px;
      border-radius:14px;
      border:1px solid rgba(207,100,229,.65);
      background:linear-gradient(180deg,#7a3bd0,#572B87);
      color:#fff;
      font-weight:950;
      cursor:pointer;
    }
    .btn:hover{filter:brightness(1.06);transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn:disabled{opacity:.6;cursor:default;transform:none;filter:none}

    .gridwrap{
      margin-top:16px;
    }

    .grid{
      display:grid;
      gap:12px;
      grid-template-columns:repeat(2,minmax(0,1fr));
    }

    @media (min-width:700px){
      .grid{grid-template-columns:repeat(3,minmax(0,1fr))}
    }
    @media (min-width:1100px){
      .grid{grid-template-columns:repeat(4,minmax(0,1fr))}
    }
    @media (min-width:1400px){
      .grid{grid-template-columns:repeat(5,minmax(0,1fr))}
    }

    .card{
      position:relative;
      border-radius:22px;
      border:1px solid #223041;
      background:rgba(16,24,32,.42);
      backdrop-filter:blur(12px);
      box-shadow:0 24px 90px rgba(0,0,0,.50);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:320px;
      cursor:pointer;
      transition:transform .18s ease, filter .18s ease;
    }
    .card:hover{transform:translateY(-6px);filter:brightness(1.07)}
    .card:active{transform:translateY(-2px)}

    .imgwrap{
      position:relative;
      aspect-ratio:1/1;
      background:rgba(12,18,24,.70);
      border-bottom:1px solid #1a2530;
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .imgwrap img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .heart{
      position:absolute;
      right:10px;
      top:10px;
      height:42px;
      width:42px;
      border-radius:14px;
      border:1px solid #2a3641;
      background:rgba(12,18,24,.55);
      backdrop-filter:blur(10px);
      display:grid;
      place-items:center;
      cursor:pointer;
      z-index:2;
    }
    .heart:hover{filter:brightness(1.08)}
    .heart svg{width:20px;height:20px;color:#e8eef4}
    .heart.on{border:1px solid rgba(207,100,229,.65)}
    .heart.on svg{color:var(--pink)}

    .body{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1;
    }

    .name{
      font-weight:950;
      letter-spacing:.01em;
      line-height:1.2;
      font-size:1.05rem;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      min-height:2.5em;
    }

    .meta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .setno{
      color:var(--muted);
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:.78rem;
    }

    .price{
      font-weight:950;
      font-size:1.25rem;
      letter-spacing:.01em;
      color:#fff;
    }

    .sources{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:2px;
    }
    .chip{
      border:1px solid #2a3641;
      background:rgba(12,18,24,.55);
      border-radius:999px;
      padding:7px 9px;
      font-weight:900;
      font-size:.78rem;
      color:#d9e1e8;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .chip span{color:var(--muted);font-weight:800}
    .chip.best{border:1px solid rgba(0,229,255,.45)}
    .chip.best span{color:#bff7ff}

    .cta{
      margin-top:auto;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .openbtn{
      width:100%;
      height:42px;
      border-radius:14px;
      border:1px solid rgba(207,100,229,.65);
      background:linear-gradient(180deg,#7a3bd0,#572B87);
      color:#fff;
      font-weight:950;
      cursor:pointer;
    }
    .openbtn:hover{filter:brightness(1.06);transform:translateY(-1px)}
    .openbtn:active{transform:translateY(0)}

    .empty{
      margin-top:16px;
      border:1px solid var(--border);
      background:rgba(12,18,24,.55);
      border-radius:18px;
      padding:14px;
      color:#cfd6dd;
      font-weight:850;
      line-height:1.5;
    }

    .pager{
      margin-top:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .pagebtn{
      height:44px;
      padding:0 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--panel2);
      color:#fff;
      font-weight:950;
      cursor:pointer;
    }
    .pagebtn:hover{filter:brightness(1.06);transform:translateY(-1px)}
    .pagebtn:active{transform:translateY(0)}
    .pagebtn:disabled{opacity:.5;cursor:default;transform:none;filter:none}

    .pinfo{
      color:var(--muted);
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-size:.8rem;
    }

    @media (max-width:900px){
      .controls{grid-template-columns:1fr 1fr;gap:10px}
    }
    @media (max-width:520px){
      .title{font-size:1.65rem}
      .controls{grid-template-columns:1fr;gap:10px}
      .navlinks{display:none}
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <a class="brand" href="/index.html" aria-label="SetHub">
        <div class="dot" aria-hidden="true"></div>
        <div>
          <strong>SetHub</strong>
          <span>Sale</span>
        </div>
      </a>

      <div class="navlinks">
        <a class="navbtn" href="/news.html"><strong>News</strong><small>Updates</small></a>
        <a class="navbtn" href="/events.html"><strong>Events</strong><small>Dates</small></a>
        <a class="navbtn" href="/sale.html"><strong>Sale</strong><small>Deals</small></a>
      </div>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="herohead">
        <div>
          <div class="title">Sale Deals</div>
          <div class="subtitle">Amazon · LEGO · Alternate</div>
        </div>
        <div class="stats">
          <div class="pill"><span>Sets</span><strong id="statSets">0</strong></div>
          <div class="pill"><span>Wishlist</span><strong id="statWish">0</strong></div>
        </div>
      </div>

      <div class="controls" role="search">
        <input class="field" id="q" placeholder="Suche Set Name oder Set Number" autocomplete="off" />

        <select class="field" id="sort">
          <option value="best">Billigste zuerst</option>
          <option value="worst">Teuerste zuerst</option>
          <option value="name_az">Name A bis Z</option>
          <option value="name_za">Name Z bis A</option>
          <option value="set_asc">Set Number aufsteigend</option>
          <option value="set_desc">Set Number absteigend</option>
        </select>

        <select class="field" id="source">
          <option value="all">Alle Quellen</option>
          <option value="amazon">Nur Amazon</option>
          <option value="lego">Nur LEGO</option>
          <option value="alternate">Nur Alternate</option>
        </select>

        <button class="btn" id="reload" type="button">Reload</button>
      </div>
    </section>

    <section class="gridwrap" aria-label="Sale Sets">
      <div class="grid" id="grid"></div>

      <div class="empty" id="empty" hidden>
        Keine Treffer
      </div>

      <div class="pager" id="pager" hidden>
        <button class="pagebtn" id="prev" type="button">Zurück</button>
        <div class="pinfo" id="pinfo">Seite 1</div>
        <button class="pagebtn" id="next" type="button">Weiter</button>
      </div>
    </section>
  </main>

  <script>
    const API = {
      amazon: 'https://sethub.ddnsfree.com/SaleScraper/api/Amazon/sales',
      lego: 'https://sethub.ddnsfree.com/SaleScraper/api/Lego',
      alternate: 'https://sethub.ddnsfree.com/SaleScraper/api/Alternate'
    }

    const MAX_SETS = 200
    const PAGE_SIZE = pickPageSize()

    const els = {
      q: document.getElementById('q'),
      sort: document.getElementById('sort'),
      source: document.getElementById('source'),
      reload: document.getElementById('reload'),
      grid: document.getElementById('grid'),
      empty: document.getElementById('empty'),
      pager: document.getElementById('pager'),
      prev: document.getElementById('prev'),
      next: document.getElementById('next'),
      pinfo: document.getElementById('pinfo'),
      statSets: document.getElementById('statSets'),
      statWish: document.getElementById('statWish')
    }

    let raw = []
    let view = []
    let page = 1
    let wishlist = loadWishlist()

    updateWishStat()

    function pickPageSize(){
      const w = window.innerWidth || 1200
      if(w <= 520) return 12
      if(w <= 900) return 18
      return 20
    }

    function loadWishlist(){
      try{
        const x = JSON.parse(localStorage.getItem('sethub_wishlist') || '[]')
        if(Array.isArray(x)) return new Set(x.map(String))
        return new Set()
      }catch{
        return new Set()
      }
    }

    function saveWishlist(){
      localStorage.setItem('sethub_wishlist', JSON.stringify([...wishlist]))
      updateWishStat()
    }

    function updateWishStat(){
      els.statWish.textContent = String(wishlist.size)
    }

    function money(v){
      const n = Number(v)
      if(!isFinite(n)) return null
      return n
    }

    function formatEUR(n){
      try{
        return new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(n)
      }catch{
        return (Math.round(n * 100) / 100).toFixed(2) + ' €'
      }
    }

    function normItem(source, item){
      const it = item || {}

      const setNumber =
        it.setNumber ?? it.setnumber ?? it.set_no ?? it.setNo ?? it.number ?? it.set ?? it.id ?? it.setId

      const name =
        it.name ?? it.title ?? it.setName ?? it.productName ?? it.product ?? it.headline ?? it.description

      const url =
        it.url ?? it.link ?? it.productUrl ?? it.href ?? it.detailUrl ?? it.page

      const image =
        it.image ?? it.img ?? it.imageUrl ?? it.image_url ?? it.thumbnail ?? it.thumb ?? it.picture ?? it.photo

      const price =
        it.price ?? it.currentPrice ?? it.salePrice ?? it.now ?? it.value ?? it.bestPrice ?? it.lowestPrice

      const oldPrice =
        it.oldPrice ?? it.wasPrice ?? it.regularPrice ?? it.listPrice ?? it.before ?? it.msrp

      const discount =
        it.discount ?? it.percent ?? it.discountPercent ?? it.off

      return {
        source,
        setNumber: setNumber != null ? String(setNumber).trim() : '',
        name: name != null ? String(name).trim() : '',
        url: url != null ? String(url).trim() : '',
        image: image != null ? String(image).trim() : '',
        price: money(price),
        oldPrice: money(oldPrice),
        discount: money(discount)
      }
    }

    function mergeBySetNumber(list){
      const map = new Map()

      for(const x of list){
        if(!x.setNumber) continue
        if(!x.price && x.price !== 0) continue

        const key = x.setNumber
        const cur = map.get(key) || {
          setNumber: key,
          name: x.name || '',
          image: x.image || '',
          sources: {},
          best: null
        }

        if(!cur.name && x.name) cur.name = x.name
        if(!cur.image && x.image) cur.image = x.image

        cur.sources[x.source] = {
          price: x.price,
          oldPrice: x.oldPrice,
          url: x.url,
          image: x.image,
          name: x.name
        }

        const curBest = cur.best
        if(!curBest || x.price < curBest.price){
          cur.best = { source: x.source, price: x.price, url: x.url }
        }

        map.set(key, cur)
      }

      return [...map.values()]
    }

    async function fetchSource(source, url){
      const r = await fetch(url, { method:'GET' })
      const data = await r.json()

      const arr = Array.isArray(data) ? data : (Array.isArray(data.items) ? data.items : (Array.isArray(data.data) ? data.data : []))
      return arr.map(it => normItem(source, it))
    }

    async function loadAll(){
      els.reload.disabled = true

      const [a,l,alt] = await Promise.allSettled([
        fetchSource('amazon', API.amazon),
        fetchSource('lego', API.lego),
        fetchSource('alternate', API.alternate)
      ])

      const all = []
      if(a.status === 'fulfilled') all.push(...a.value)
      if(l.status === 'fulfilled') all.push(...l.value)
      if(alt.status === 'fulfilled') all.push(...alt.value)

      const merged = mergeBySetNumber(all)

      merged.sort((x,y)=> (x.best?.price ?? 1e18) - (y.best?.price ?? 1e18))

      raw = merged.slice(0, MAX_SETS)

      els.statSets.textContent = String(raw.length)

      page = 1
      apply()
      els.reload.disabled = false
    }

    function apply(){
      const q = (els.q.value || '').trim().toLowerCase()
      const s = els.source.value
      const sort = els.sort.value

      let out = raw

      if(s !== 'all'){
        out = out.filter(x => x.sources[s] && isFinite(x.sources[s].price))
      }

      if(q){
        out = out.filter(x => {
          const n = (x.name || '').toLowerCase()
          const id = (x.setNumber || '').toLowerCase()
          return n.includes(q) || id.includes(q)
        })
      }

      out = out.slice()

      if(sort === 'best'){
        out.sort((a,b)=> (a.best?.price ?? 1e18) - (b.best?.price ?? 1e18))
      }else if(sort === 'worst'){
        out.sort((a,b)=> (b.best?.price ?? -1) - (a.best?.price ?? -1))
      }else if(sort === 'name_az'){
        out.sort((a,b)=> (a.name || '').localeCompare((b.name || ''), 'de', { sensitivity:'base' }))
      }else if(sort === 'name_za'){
        out.sort((a,b)=> (b.name || '').localeCompare((a.name || ''), 'de', { sensitivity:'base' }))
      }else if(sort === 'set_asc'){
        out.sort((a,b)=> (a.setNumber || '').localeCompare((b.setNumber || ''), 'de', { numeric:true }))
      }else if(sort === 'set_desc'){
        out.sort((a,b)=> (b.setNumber || '').localeCompare((a.setNumber || ''), 'de', { numeric:true }))
      }

      view = out
      render()
    }

    function getBestUrl(x){
      const b = x.best
      if(b && b.url) return b.url
      const order = ['alternate','lego','amazon']
      for(const k of order){
        const s = x.sources[k]
        if(s && s.url) return s.url
      }
      return ''
    }

    function render(){
      const total = view.length
      const pages = Math.max(1, Math.ceil(total / PAGE_SIZE))
      page = Math.min(page, pages)

      const start = (page - 1) * PAGE_SIZE
      const items = view.slice(start, start + PAGE_SIZE)

      els.grid.innerHTML = ''
      els.empty.hidden = items.length !== 0
      els.pager.hidden = total <= PAGE_SIZE

      els.prev.disabled = page <= 1
      els.next.disabled = page >= pages
      els.pinfo.textContent = 'Seite ' + page + ' von ' + pages

      for(const x of items){
        const bestPrice = x.best?.price
        const bestSource = x.best?.source

        const url = getBestUrl(x)
        const name = x.name || 'Set'
        const img = x.image || x.sources[bestSource]?.image || ''
        const setNumber = x.setNumber || ''

        const card = document.createElement('div')
        card.className = 'card'
        card.tabIndex = 0
        card.setAttribute('role','button')
        card.setAttribute('aria-label', name)

        card.addEventListener('click', (e)=>{
          const t = e.target
          if(t && t.closest && t.closest('.heart')) return
          if(t && t.closest && t.closest('.openbtn')) return
          if(url) window.open(url, '_blank', 'noopener')
        })
        card.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter' || e.key === ' '){
            e.preventDefault()
            if(url) window.open(url, '_blank', 'noopener')
          }
        })

        const heartOn = wishlist.has(setNumber)

        card.innerHTML = `
          <div class="imgwrap">
            ${img ? `<img loading="lazy" src="${escapeHtml(img)}" alt="${escapeHtml(name)}">` : ``}
            <button class="heart ${heartOn ? 'on' : ''}" type="button" aria-label="Wishlist">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 21s-7-4.6-9.3-9C1.3 9 3.2 6 6.5 6c1.9 0 3.2 1 3.9 2c.7-1 2-2 3.9-2C17.6 6 19.5 9 21.3 12c-2.3 4.4-9.3 9-9.3 9Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>

          <div class="body">
            <div class="name">${escapeHtml(name)}</div>

            <div class="meta">
              <div class="setno">Set ${escapeHtml(setNumber)}</div>
              <div class="price">${isFinite(bestPrice) ? escapeHtml(formatEUR(bestPrice)) : '-'}</div>
            </div>

            <div class="sources">
              ${sourceChip('amazon', x, bestSource)}
              ${sourceChip('lego', x, bestSource)}
              ${sourceChip('alternate', x, bestSource)}
            </div>

            <div class="cta">
              <button class="openbtn" type="button">Open Deal</button>
            </div>
          </div>
        `

        const heart = card.querySelector('.heart')
        heart.addEventListener('click', ()=>{
          if(!setNumber) return
          if(wishlist.has(setNumber)) wishlist.delete(setNumber)
          else wishlist.add(setNumber)
          heart.classList.toggle('on')
          saveWishlist()
        })

        const openBtn = card.querySelector('.openbtn')
        openBtn.addEventListener('click', ()=>{
          if(url) window.open(url, '_blank', 'noopener')
        })

        els.grid.appendChild(card)
      }
    }

    function sourceChip(source, x, bestSource){
      const s = x.sources[source]
      if(!s || !isFinite(s.price)) return ''
      const isBest = source === bestSource
      const cls = 'chip' + (isBest ? ' best' : '')
      const label = source === 'amazon' ? 'Amazon' : (source === 'lego' ? 'LEGO' : 'Alternate')
      return `
        <div class="${cls}">
          ${label}
          <span>${escapeHtml(formatEUR(s.price))}</span>
        </div>
      `
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;")
    }

    function debounce(fn, ms){
      let t = 0
      return (...args)=>{
        clearTimeout(t)
        t = setTimeout(()=> fn(...args), ms)
      }
    }

    els.prev.addEventListener('click', ()=>{ page = Math.max(1, page - 1); render(); window.scrollTo({top:0,behavior:'smooth'}) })
    els.next.addEventListener('click', ()=>{ page = page + 1; render(); window.scrollTo({top:0,behavior:'smooth'}) })

    els.sort.addEventListener('change', ()=>{ page = 1; apply() })
    els.source.addEventListener('change', ()=>{ page = 1; apply() })
    els.q.addEventListener('input', debounce(()=>{ page = 1; apply() }, 140))

    els.reload.addEventListener('click', loadAll)

    window.addEventListener('resize', debounce(()=>{
      const newSize = pickPageSize()
      if(newSize !== PAGE_SIZE){
        location.reload()
      }
    }, 250))

    loadAll()
  </script>
</body>
</html>
